import requests
import json
import os

overpass_url = "https://overpass-api.de/api/interpreter"

consulta = """
[out:json][timeout:30];
(
  node["shop"="greengrocer"](37.30,-6.05,37.45,-5.85);   # fruterías
  node["shop"="bakery"](37.30,-6.05,37.45,-5.85);        # panaderías
  node["shop"="butcher"](37.30,-6.05,37.45,-5.85);       # carnicerías
);
out center;
"""

print("Lanzando consulta a Overpass...")
resp = requests.get(overpass_url, params={"data": consulta})
resp.raise_for_status()

data = resp.json()

locales = []
for elem in data.get("elements", []):
    lat = elem.get("lat")
    lon = elem.get("lon")
    tags = elem.get("tags", {})

    if lat is None or lon is None:
        continue

    nombre = tags.get("name", "Sin nombre")
    shop = tags.get("shop", "")

    if shop == "greengrocer":
        tipo = "fruteria_espanola"
    elif shop == "bakery":
        tipo = "panaderia"
    elif shop == "butcher":
        tipo = "carniceria"
    else:
        tipo = "otro"

    locales.append({
        "nombre": nombre,
        "lat": lat,
        "lng": lon,
        "tipo": tipo
    })

os.makedirs("data", exist_ok=True)

ruta_salida = os.path.join("data", "locales.json")
with open(ruta_salida, "w", encoding="utf-8") as f:
    json.dump(locales, f, ensure_ascii=False, indent=2)

print(f"Archivo guardado en {ruta_salida} con {len(locales)} locales.")
